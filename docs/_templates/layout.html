{%- extends "!layout.html" %}

{%- block extrahead %}
{{ super() }}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Ensure proper layout initialization */
    body {
        margin: 0;
        padding: 0;
        font-family: "Lato", "proxima-nova", "Helvetica Neue", Arial, sans-serif;
    }
</style>
{%- endblock %}

{%- block document %}
<div class="wy-grid-for-nav">
    {%- block navigation %}
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
            <div class="wy-side-nav-search" {{ rtd_search_config }}>
                {%- block sidebartitle %}
                {%- if logo %}
                <a href="{{ pathto(master_doc) }}">
                {%- else %}
                <a href="{{ pathto(master_doc) }}" class="icon icon-home">
                {%- endif %}
                {%- if logo %}
                {%- if logo_url %}
                <img src="{{ logo_url }}" class="logo" alt="{{ _('Logo') }}"/>
                {%- else %}
                <img src="{{ pathto('_static/' + logo, 1) }}" class="logo" alt="{{ _('Logo') }}"/>
                {%- endif %}
                {%- endif %}
                {%- if theme_logo_only %}
                <span class="version">{{ release|e }}</span>
                {%- else %}
                {{ project }}
                {%- if display_version %}
                <span class="version">{{ release|e }}</span>
                {%- endif %}
                {%- endif %}
                </a>

                {%- if theme_display_version %}
                {%- set nav_version = version %}
                {%- if READTHEDOCS and current_version %}
                {%- set nav_version = current_version %}
                {%- endif %}
                {%- if nav_version %}
                <div class="version">
                {{ nav_version }}
                </div>
                {%- endif %}
                {%- endif %}

                {%- include "searchbox.html" %}
                {%- endblock %}
            </div>

            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                {%- block menu %}
                {%- set toctree = toctree(maxdepth=theme_navigation_depth|int,
                                        collapse=theme_collapse_navigation|tobool,
                                        includehidden=theme_includehidden|tobool,
                                        titles_only=theme_titles_only|tobool) %}
                {%- if toctree %}
                {{ toctree }}
                {%- else %}
                <!-- Empty TOC -->
                {%- endif %}
                {%- endblock %}
            </div>
        </div>
    </nav>
    {%- endblock %}

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        {%- block mobile_nav %}
        <nav class="wy-nav-top" aria-label="Mobile navigation menu" {%- if theme_style_nav_header_background %} style="background: {{theme_style_nav_header_background}}"{% endif %}>
            {%- block mobile_nav_content %}
            <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
            <a href="{{ pathto(master_doc) }}">{{ project }}</a>
            {%- endblock %}
        </nav>
        {%- endblock %}

        <div class="wy-nav-content">
            <div class="rst-content">
                {%- block content %}
                {%- include "breadcrumbs.html" %}
                
                <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                    {%- block document_content %}
                    <div itemprop="articleBody">
                        {% block body %}{% endblock %}
                    </div>
                    {%- if self.comments()|trim %}
                    <div class="articleComments">
                        {% block comments %}{% endblock %}
                    </div>
                    {%- endif%}
                    {%- endblock %}
                </div>
                
                {%- include "footer.html" %}
                {%- endblock %}
            </div>
        </div>
    </section>

    {%- block right_sidebar %}
    <aside class="right-sidebar">
        <div class="right-sidebar-content">
            {%- if display_toc and toc %}
            <div class="local-toc-section">
                <h3>{{ _('On This Page') }}</h3>
                <div class="local-toc">
                    {{ toc }}
                </div>
            </div>
            {%- endif %}

            {%- if pagename %}
            <div class="page-relations">
                <h4>{{ _('Navigation') }}</h4>
                <ul>
                    {%- if prev %}
                    <li>
                        <i class="fa fa-chevron-left"></i>
                        <a href="{{ prev.link|e }}" title="{{ prev.title|e }}">
                            {{ prev.title|truncate(25) }}
                        </a>
                    </li>
                    {%- endif %}
                    {%- if next %}
                    <li>
                        <i class="fa fa-chevron-right"></i>
                        <a href="{{ next.link|e }}" title="{{ next.title|e }}">
                            {{ next.title|truncate(25) }}
                        </a>
                    </li>
                    {%- endif %}
                </ul>
            </div>
            {%- endif %}

            {%- if show_source and has_source and sourcename %}
            <div class="page-source">
                <h4>{{ _('Page Source') }}</h4>
                <ul>
                    <li>
                        <a href="{{ pathto('_sources/' + sourcename, true)|e }}">
                            {{ _('Show Source') }}
                        </a>
                    </li>
                    {%- if display_github %}
                    <li>
                        <a href="https://{{ github_host|default('github.com') }}/{{ github_user }}/{{ github_repo }}/{{ theme_vcs_pageview_mode|default('blob') }}/{{ github_version }}{{ conf_py_path }}{{ pagename }}{{ suffix }}" class="fa fa-github">
                            {{ _('Edit on GitHub') }}
                        </a>
                    </li>
                    {%- endif %}
                </ul>
            </div>
            {%- endif %}
        </div>
    </aside>
    {%- endblock %}
</div>

{# Mobile menu JavaScript #}
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Mobile menu toggle
    var navToggle = document.querySelector('[data-toggle="wy-nav-top"]');
    var nav = document.querySelector('.wy-nav-side');
    
    if (navToggle && nav) {
        navToggle.addEventListener('click', function() {
            nav.classList.toggle('shift');
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!nav.contains(event.target) && !navToggle.contains(event.target)) {
                nav.classList.remove('shift');
            }
        });
    }
    
    // Right sidebar TOC highlighting
    var rightTocLinks = document.querySelectorAll('.right-sidebar .local-toc a');
    var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    function highlightCurrentSection() {
        var scrollPosition = window.scrollY + 100; // Offset for better UX
        var currentHeading = null;
        
        headings.forEach(function(heading) {
            if (heading.offsetTop <= scrollPosition) {
                currentHeading = heading;
            }
        });
        
        // Remove current class from all links
        rightTocLinks.forEach(function(link) {
            link.classList.remove('current');
        });
        
        // Add current class to matching link
        if (currentHeading && currentHeading.id) {
            var currentLink = document.querySelector('.right-sidebar .local-toc a[href="#' + currentHeading.id + '"]');
            if (currentLink) {
                currentLink.classList.add('current');
            }
        }
    }
    
    // Highlight on scroll
    if (rightTocLinks.length > 0) {
        window.addEventListener('scroll', highlightCurrentSection);
        highlightCurrentSection(); // Initial highlight
    }
    
    // Responsive behavior
    function handleResize() {
        var windowWidth = window.innerWidth;
        var rightSidebar = document.querySelector('.right-sidebar');
        
        if (rightSidebar) {
            if (windowWidth < 768) {
                rightSidebar.style.display = 'none';
            } else if (windowWidth < 1024) {
                rightSidebar.style.display = 'none';
            } else {
                rightSidebar.style.display = 'block';
            }
        }
    }
    
    window.addEventListener('resize', handleResize);
    handleResize(); // Initial check
});
</script>

{%- endblock %}
